<!DOCTYPE html>
<html>
  <head>
    <title>RipDB Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <div class="half">
      <div class="imageWrapper">
        <img class="ripDBImage" src="/images/RipDB.png" />
      </div>
      <h1 class="mainText">
        RipDB is a dead simple, fast, decentralized <br />
        JSON store built for web3.
      </h1>
      <p class="sub">Redis + IPFS = RIP = 😍</p>
    </div>
    <div class="secondHalf">
      <div class="secondHalfInner">
        <h1>Try it out!</h1>
        <p>
          Rip has three functions (for now). Set, Get, and Purge. The following
          demo shows how you can use RIP as simple JSON storage for your web3
          app. The following demo interfaces with a live RipDB instance.
        </p>
        <h2>Set</h2>
        <hr />
        <h3>Key</h3>
        <input
          type="text"
          value="exampleKey"
          id="setKey"
          oninput="onSetKeyChange()"
        />
        <h3>Value</h3>
        <textarea class="json" id="setValue"></textarea>
        <div class="timeVals">
          <div id="setBenchmark">
            <div class="timeMs">N/A</div>
            <div class="timeLabel">RIP set time ms</div>
          </div>
          <div id="setBenchmarkIPFS">
            <div class="timeMs">N/A</div>
            <div class="timeLabel">IPFS upload time ms</div>
          </div>
          <button onclick="runSet()">Set Data</button>
        </div>
        <h2>Get</h2>
        <hr />
        <h3>Key</h3>
        <input type="text" value="exampleKey" id="getKey" />
        <h3>Value</h3>
        <textarea class="json" id="getValue"></textarea>
        <div class="timeVals">
          <div id="getBenchmark">
            <div class="timeMs">N/A</div>
            <div class="timeLabel">RIP get time ms</div>
          </div>
          <div id="getBenchmarkIPFS">
            <div class="timeMs">N/A</div>
            <div class="timeLabel">IPFS fetch time ms</div>
          </div>
          <button onclick="runGet()">Get Data</button>
        </div>
        <h2>Purge</h2>
        <hr />
        <h3>Key</h3>
        <input type="text" value="exampleKey" id="purgeKey" />
        <div class="timeVals">
          <div></div>
          <div></div>
          <button onclick="runPurge()">Purge Cache</button>
        </div>
      </div>
      <h1>🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥 🔥</h1>
      <h1>Encryption</h1>
      <button id="litConnectButton" onclick="connectLit()">
        Connect to Encrypt Data
      </button>
      <h2>Encrypted Set</h2>
      <hr />
      <h3>Key</h3>
      <input type="text" value="exampleKey" id="encryptedSetKey" />
      <h3>Value</h3>
      <div style="height: 300px">
        <textarea class="json" id="encryptedSetValue"></textarea>
      </div>
      <div class="timeVals">
        <div id="setBenchmark">
          <div class="timeMs">N/A</div>
          <div class="timeLabel">RIP set time ms</div>
        </div>
        <div id="setBenchmarkIPFS">
          <div class="timeMs">N/A</div>
          <div class="timeLabel">IPFS upload time ms</div>
        </div>
        <button onclick="runEncryptAndSet()">Encrypt and Set Data</button>
      </div>
    </div>

    <style>
      html,
      body {
        font-family: 'Roboto', sans-serif;
      }

      input {
        width: 300px;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid lightgrey;
      }

      hr {
        width: 100%;
        border: none;
        border-bottom: 1px dashed lightgrey;
      }

      button {
        background: black;
        border-radius: 5px;
        color: white;
        padding: 12px 35px;
        font-weight: bold;
        font-size: 16px;
        border: none;
        cursor: pointer;
        margin: 25px 0px;
      }

      .timeVals {
        display: flex;
        align-items: center;
        flex-direction: row;
        width: 100%;
        justify-content: space-between;
      }

      .json {
        width: 100%;
        height: 300px;
        min-height: 300px;
        color: black;
        background: #f9f9f9;
        padding: 15px;
        border-radius: 15px;
        border: 1px solid lightgrey;
        box-sizing: border-box;
      }

      .json::-webkit-scrollbar {
        display: none;
      }

      .sub {
        font-size: 22px;
        color: white;
        text-align: center;
      }

      .mainText {
        margin-top: 50px;
        width: 700px;
        text-align: center;
      }

      .timeLabel {
        color: grey;
        font-size: 14px;
      }

      .ripDBImage {
        width: 300px;
        height: 300px;
      }

      .timeMs {
        font-size: 25px;
      }

      .imageWrapper {
        padding: 30px 50px;
        border-radius: 30px;
        background: white;
      }

      .half {
        color: white;
        width: 50vw;
        height: 100vh;
        position: fixed;
        flex-direction: column;
        top: 0px;
        left: 0px;
        bottom: 0px;
        background: black;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .secondHalf {
        position: fixed;
        top: 0px;
        right: 0px;
        bottom: 0px;
        width: 50vw;
        height: 100vh;
        overflow-y: scroll;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        padding: 50px;
        color: black;
        box-sizing: border-box;
      }
    </style>

    <script>
      const baseUrl = 'http://localhost:3500';

      const runSet = async () => {
        const key = document.getElementById('setKey').value;
        const value = document.getElementById('setValue').value;

        const opts = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: value,
        };

        const resPromise = fetch(`${baseUrl}/set/${key}`, opts);
        const res2Promise = fetch(`${baseUrl}/ipfs/set`, opts);

        const res = await resPromise;
        const json = await res.json();
        document.getElementById('setBenchmark').children[0].innerText =
          json.duration.toString();

        const res2 = await res2Promise;
        const json2 = await res2.json();
        document.getElementById('setBenchmarkIPFS').children[0].innerText =
          json2.duration.toString();
      };

      const runGet = async () => {
        const key = document.getElementById('getKey').value;

        const resPromise = fetch(`${baseUrl}/get/${key}`);
        const res2Promise = fetch(`${baseUrl}/ipfs/get/${key}`);

        const res = await resPromise;
        const json = await res.json();

        document.getElementById('getBenchmark').children[0].innerText =
          json.duration.toString();

        document.getElementById('getValue').value = JSON.stringify(
          json.wrappedData,
          null,
          2
        );

        const res2 = await res2Promise;
        const json2 = await res2.json();

        document.getElementById('getBenchmarkIPFS').children[0].innerText =
          json2.duration.toString();
      };

      const runPurge = async () => {
        const key = document.getElementById('purgeKey').value;
        const res = await fetch(`${baseUrl}/purge/${key}`, { method: 'POST' });

        const getDisplay = document.getElementById('getValue');

        if (getDisplay.value.length > 0) {
          const next = { ...JSON.parse(getDisplay.value), data: '' };
          getDisplay.value = JSON.stringify(next, null, 2);
        }
      };

      const fetchSampleJSON = async () => {
        const res = await fetch('/json/example.json');
        const json = await res.json();
        const text = JSON.stringify(json, null, 2);
        document.getElementById('setValue').value = text;
        document.getElementById('encryptedSetValue').value = text;
      };

      const onSetKeyChange = (e) => {
        const value = document.getElementById('setKey').value;
        document.getElementById('getKey').value = value;
        document.getElementById('purgeKey').value = value;
      };

      // LIT PROTOCOL STUFF HERE

      let authSig;
      const connectLit = async () => {
        authSig = await LitJsSdk.checkAndSignAuthMessage({
          chain: 'ethereum',
        });
      };

      const runEncryptAndSet = async () => {
        const currData = document.getElementById('encryptedSetValue').value;
        const { encryptedString, symmetricKey } = await LitJsSdk.encryptString(
          currData
        );
      };

      fetchSampleJSON();
    </script>
    <script
      onload="LitJsSdk.litJsSdkLoadedInALIT()"
      src="https://jscdn.litgateway.com/index.web.js"
    ></script>
  </body>
</html>
